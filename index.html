<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拜拜小幫手 (BaiBai Note)</title>
    
    <!-- 1. 引入核心函式庫 (React, Tailwind, Lunar) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lunar-javascript/lunar.js"></script>

    <!-- 設定 Tailwind 字型 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        /* 動畫效果 */
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // 為了方便，這裡手寫 SVG Icon 元件，避免 CDN 依賴問題
        const Icons = {
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Bell: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Gift: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Close: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 12"/></svg>
        };

        // ==========================================
        // 1. 資料庫
        // ==========================================
        const WORSHIP_DATA = [
            { id: 'cny_eve', title: '除夕 - 祭祖與地基主', type: 'yearly', lunarMonth: 12, lunarDay: 29, targets: ['祖先', '地基主'], items: ['三牲', '年糕', '發糕', '水果', '刈金', '銀紙'], notes: ['除夕需在傍晚前拜完', '地基主在廚房往內拜'] },
            { id: 'cny_01', title: '大年初一 - 走春拜天公', type: 'yearly', lunarMonth: 1, lunarDay: 1, targets: ['玉皇大帝', '神明'], items: ['素果', '年糕', '甜茶', '壽金', '天公金'], notes: ['忌殺生，建議全素', '早上越早拜越好'] },
            { id: 'cny_04', title: '大年初四 - 接神', type: 'yearly', lunarMonth: 1, lunarDay: 4, targets: ['家中神明', '灶神'], items: ['水果', '三牲', '發糕', '金紙'], notes: ['下午過後或是傍晚進行'] },
            { id: 'cny_05', title: '大年初五 - 開工迎財神', type: 'yearly', lunarMonth: 1, lunarDay: 5, targets: ['五路財神', '土地公'], items: ['甜食', '發糕', '水果', '壽金'], notes: ['放鞭炮迎財神', '將過年垃圾倒掉(送窮)'] },
            { id: 'lantern', title: '元宵節 - 天官大帝', type: 'yearly', lunarMonth: 1, lunarDay: 15, targets: ['天官大帝', '祖先'], items: ['湯圓', '三牲', '水果'], notes: ['求平安、求財'] },
            { id: 'tomb', title: '清明節 - 掃墓祭祖', type: 'solar_term', targets: ['祖先', '后土'], items: ['潤餅', '草仔粿', '紅龜粿', '三牲'], notes: ['掛紙(壓墓紙)', '祭拜後分享供品'] },
            { id: 'dragon', title: '端午節 - 祭祖地基主', type: 'yearly', lunarMonth: 5, lunarDay: 5, targets: ['祖先', '地基主'], items: ['粽子', '水果', '雄黃酒'], notes: ['門口掛艾草', '取午時水'] },
            { id: 'ghost', title: '中元普渡', type: 'yearly', lunarMonth: 7, lunarDay: 15, targets: ['普渡公', '好兄弟'], items: ['三牲', '臉盆毛巾', '乖乖', '水果'], notes: ['不可說名字', '在戶外拜', '避開香蕉李子梨子(招你來)'] },
            { id: 'moon', title: '中秋節 - 拜土地公', type: 'yearly', lunarMonth: 8, lunarDay: 15, targets: ['土地公', '祖先', '月亮'], items: ['月餅', '柚子', '麻糬'], notes: ['求人緣、求子'] },
            { id: 'double9', title: '重陽節 - 敬老祭祖', type: 'yearly', lunarMonth: 9, lunarDay: 9, targets: ['祖先', '地基主'], items: ['重陽糕', '菊花酒', '三牲'], notes: ['祭祖四大節日之一'] },
            { id: 'm1_15', title: '初一/十五 - 拜神祭祖', type: 'monthly', days: [1, 15], targets: ['神明', '祖先'], items: ['水果', '茶'], notes: ['上午吉時最佳'] },
            { id: 'm2_16', title: '初二/十六 - 做牙', type: 'monthly', days: [2, 16], targets: ['土地公'], items: ['麻糬', '花生', '酒'], notes: ['頭牙(2/2)', '尾牙(12/16)需隆重'] }
        ];

        // ==========================================
        // 2. 核心邏輯：日期計算
        // ==========================================
        const getNextWorshipDate = (event) => {
            const now = new Date();
            const Lunar = window.Lunar; // 從全域變數獲取
            let candidates = [];

            if (event.type === 'monthly') {
                // 往後找 2 個月內的初一十五/初二十六
                const todayLunar = Lunar.fromDate(now);
                const nextMonthLunar = todayLunar.next(35); 

                event.days.forEach(day => {
                    [todayLunar, nextMonthLunar].forEach(baseLunar => {
                        try {
                            // 簡單處理：嘗試建立當月該日的農曆物件
                            let targetLunar = Lunar.fromYmd(baseLunar.getYear(), baseLunar.getMonth(), day);
                            const solar = targetLunar.getSolar();
                            const dateObj = new Date(solar.getYear(), solar.getMonth() - 1, solar.getDay());
                            if (dateObj >= now) { // 只要是今天以後(含今天)
                                candidates.push({ date: dateObj, display: `農曆 ${targetLunar.getMonth()}月${targetLunar.getDay()}日` });
                            }
                        } catch(e) {}
                    });
                });
            } 
            else if (event.type === 'yearly') {
                // 檢查今年和明年的該農曆日
                const currentYear = now.getFullYear();
                [currentYear, currentYear + 1].forEach(year => {
                    // 概略推算該年的農曆
                    // 精確做法是遍歷這兩年的農曆月份，這裡使用簡化邏輯：
                    // 直接用 Lunar 庫找每年的農曆對應日比較複雜，我們反過來：
                    // 讓 Lunar 庫去找該農曆年對應的西曆
                    
                    // 修正邏輯：先轉成當年的農曆年物件
                    // 這裡為了簡便，我們直接建立一個暫時的西曆轉農曆來抓年份
                    let tempLunar = Lunar.fromDate(new Date(year, 5, 1));
                    let targetLunarYear = tempLunar.getYear();
                    
                    try {
                        let lunarDate = Lunar.fromYmd(targetLunarYear, event.lunarMonth, event.lunarDay);
                        let solar = lunarDate.getSolar();
                        let dateObj = new Date(solar.getYear(), solar.getMonth() - 1, solar.getDay());
                        
                        // 如果已經過了，就不用加進去 (除非是明年)
                        if (dateObj >= now || year > currentYear) {
                             // 再次確認是否真的 >= now (對於跨年判斷)
                             if(dateObj >= now) {
                                 candidates.push({ date: dateObj, display: `農曆 ${event.lunarMonth}月${event.lunarDay}日` });
                             }
                        }
                    } catch (e) {
                        // 處理農曆除夕 (小月可能是29日)
                        if (event.lunarDay === 30) {
                             try {
                                let lunarDate = Lunar.fromYmd(targetLunarYear, 12, 29); // 試試29
                                // 這裡需要更嚴謹判斷是否為最後一天，這裡暫略
                             } catch(ex){}
                        }
                    }
                });
            }
            else if (event.type === 'solar_term') {
                 // 清明節固定在國曆 4/4, 4/5, 4/6
                 const currentYear = now.getFullYear();
                 [currentYear, currentYear + 1].forEach(year => {
                     // 簡單寫死清明節邏輯作為範例，實際可用 Lunar.getJieQiTable()
                     // 這裡假設 4月5日
                     let d = new Date(year, 3, 5);
                     if (d >= now) {
                         candidates.push({ date: d, display: '節氣：清明' });
                     }
                 });
            }

            // 排序找最近的
            candidates.sort((a, b) => a.date - b.date);
            return candidates.length > 0 ? candidates[0] : null;
        };

        const getDaysUntil = (targetDate) => {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const target = new Date(targetDate);
            target.setHours(0, 0, 0, 0);
            const diffTime = target - now; // 不取絕對值，方便判斷過去
            if (diffTime < 0) return 0; // 今天的顯示為 0
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        };

        // ==========================================
        // 3. V2 功能：加入 Google Calendar
        // ==========================================
        const addToGoogleCalendar = (event) => {
            if (!event.nextDate) return;

            const title = encodeURIComponent(`拜拜提醒：${event.title}`);
            const details = encodeURIComponent(`準備物品：${event.items.join(', ')}\n\n注意事項：${event.notes.join('、')}`);
            const location = encodeURIComponent("家中或廟宇");
            
            // 格式化日期 YYYYMMDD
            const year = event.nextDate.getFullYear();
            const month = String(event.nextDate.getMonth() + 1).padStart(2, '0');
            const day = String(event.nextDate.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            
            // Google Calendar Link 格式
            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dateStr}/${dateStr}&details=${details}&location=${location}`;
            
            window.open(url, '_blank');
        };

        // ==========================================
        // 4. 主程式 (React Component)
        // ==========================================
        function App() {
            const [events, setEvents] = useState([]);
            const [selectedEvent, setSelectedEvent] = useState(null);

            useEffect(() => {
                const calculatedEvents = WORSHIP_DATA.map(event => {
                    const nextDateInfo = getNextWorshipDate(event);
                    return {
                        ...event,
                        nextDate: nextDateInfo ? nextDateInfo.date : null,
                        nextDateDisplay: nextDateInfo ? nextDateInfo.display : '',
                        daysUntil: nextDateInfo ? getDaysUntil(nextDateInfo.date) : 999
                    };
                });

                // 排序：天數小的在前面
                calculatedEvents.sort((a, b) => a.daysUntil - b.daysUntil);
                setEvents(calculatedEvents);
            }, []);

            return (
                <div className="min-h-screen pb-12">
                    {/* Header */}
                    <header className="bg-red-700 text-white p-4 sticky top-0 z-10 shadow-md">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icons.Calendar /> 拜拜小幫手
                            </h1>
                            <span className="text-sm opacity-80">
                                {new Date().toLocaleDateString()}
                            </span>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-6">
                        
                        {/* 重點卡片：最近的一次 */}
                        {events.length > 0 && (
                            <div className="bg-white rounded-xl shadow-lg overflow-hidden border-l-4 border-red-600 transform transition hover:scale-[1.02] duration-200">
                                <div className="p-5">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded">最近一次</span>
                                        <span className="text-red-600 font-bold text-3xl">
                                            {events[0].daysUntil === 0 ? '今天' : `${events[0].daysUntil} 天後`}
                                        </span>
                                    </div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-1">{events[0].title}</h2>
                                    <p className="text-stone-500 font-medium">
                                        {events[0].nextDate?.toLocaleDateString()} ({events[0].nextDateDisplay})
                                    </p>
                                    
                                    <div className="mt-4 grid grid-cols-2 gap-3">
                                        <button 
                                            onClick={() => setSelectedEvent(events[0])}
                                            className="flex items-center justify-center gap-2 bg-red-600 text-white py-2.5 rounded-lg hover:bg-red-700 active:bg-red-800 transition font-medium"
                                        >
                                            <Icons.Info /> 查看準備
                                        </button>
                                        <button 
                                            onClick={() => addToGoogleCalendar(events[0])}
                                            className="flex items-center justify-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 py-2.5 rounded-lg hover:bg-blue-100 transition font-medium"
                                        >
                                            <Icons.Bell /> 加入行事曆
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 列表區 */}
                        <div>
                            <h3 className="text-lg font-bold mb-3 text-stone-700 pl-1 border-l-4 border-stone-300 leading-none ml-1">接下來的日子</h3>
                            <div className="space-y-3">
                                {events.slice(1).map(event => (
                                    <div 
                                        key={event.id} 
                                        onClick={() => setSelectedEvent(event)}
                                        className="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition cursor-pointer flex justify-between items-center active:bg-stone-50"
                                    >
                                        <div>
                                            <h4 className="font-bold text-gray-800">{event.title}</h4>
                                            <p className="text-sm text-stone-500 mt-1">
                                                {event.nextDate?.toLocaleDateString()} <span className="text-xs bg-stone-100 px-1.5 py-0.5 rounded ml-1">{event.nextDateDisplay}</span>
                                            </p>
                                        </div>
                                        <div className="flex items-center text-stone-400">
                                            <span className="mr-2 text-sm font-medium text-red-500 bg-red-50 px-2 py-0.5 rounded-full">{event.daysUntil} 天後</span>
                                            <Icons.ChevronRight />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>

                    {/* 詳細資訊 Modal */}
                    {selectedEvent && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm" onClick={() => setSelectedEvent(null)}>
                            <div className="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl overflow-hidden max-h-[90vh] overflow-y-auto animate-slide-up shadow-2xl" onClick={e => e.stopPropagation()}>
                                
                                <div className="bg-red-600 p-6 text-white relative">
                                    <button 
                                        onClick={() => setSelectedEvent(null)}
                                        className="absolute top-4 right-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition"
                                    >
                                        <Icons.Close />
                                    </button>
                                    <h2 className="text-2xl font-bold mb-1">{selectedEvent.title}</h2>
                                    <p className="opacity-90 font-medium text-lg">
                                        {selectedEvent.nextDate?.toLocaleDateString()} 
                                        <span className="ml-2 text-sm bg-white/20 px-2 py-0.5 rounded">
                                            {selectedEvent.nextDateDisplay}
                                        </span>
                                    </p>
                                </div>

                                <div className="p-6 space-y-6">
                                    {/* 對象 */}
                                    <section>
                                        <h3 className="flex items-center gap-2 font-bold text-gray-900 mb-3 text-lg border-b pb-2">
                                            <span className="text-red-600"><Icons.User /></span> 拜拜對象
                                        </h3>
                                        <div className="flex flex-wrap gap-2">
                                            {selectedEvent.targets.map((t, i) => (
                                                <span key={i} className="bg-stone-100 text-stone-700 border border-stone-200 px-3 py-1.5 rounded-full text-sm font-medium">{t}</span>
                                            ))}
                                        </div>
                                    </section>

                                    {/* 準備物品 */}
                                    <section>
                                        <h3 className="flex items-center gap-2 font-bold text-gray-900 mb-3 text-lg border-b pb-2">
                                            <span className="text-red-600"><Icons.Gift /></span> 準備物品
                                        </h3>
                                        <ul className="grid grid-cols-2 gap-x-4 gap-y-2">
                                            {selectedEvent.items.map((item, i) => (
                                                <li key={i} className="flex items-start gap-2 text-stone-600 text-sm">
                                                    <span className="mt-1.5 w-1.5 h-1.5 rounded-full bg-red-400 flex-shrink-0"></span>
                                                    <span>{item}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </section>

                                    {/* 注意事項 */}
                                    <section>
                                        <h3 className="flex items-center gap-2 font-bold text-gray-900 mb-3 text-lg border-b pb-2">
                                            <span className="text-red-600"><Icons.AlertCircle /></span> 注意事項
                                        </h3>
                                        <ul className="bg-amber-50 p-4 rounded-lg border border-amber-100 space-y-2">
                                            {selectedEvent.notes.map((note, i) => (
                                                <li key={i} className="text-sm text-stone-700 leading-relaxed flex gap-2">
                                                    <span className="font-bold text-amber-600">!</span>
                                                    {note}
                                                </li>
                                            ))}
                                        </ul>
                                    </section>
                                    
                                    {/* V2 功能按鈕 */}
                                    <div className="pt-2">
                                        <button 
                                            onClick={() => addToGoogleCalendar(selectedEvent)}
                                            className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition flex items-center justify-center gap-2"
                                        >
                                            <Icons.Bell /> 加入 Google 行事曆提醒
                                        </button>
                                        <p className="text-xs text-center text-stone-400 mt-2">點擊將跳轉至 Google 日曆並自動填入資訊</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
